<!DOCTYPE html>
<html lang="en">
<head>
	<title>Redirects</title>
	<base href="https://techiecable.github.io" target="_self">
	<link rel="icon" href="img/favicon.svg" type="image/svg+xml">
	<link rel='alternate icon' href='img/favicon.ico' type='image/x-icon'>
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/links.css">
</head>
<script type="text/javascript" src="js/aes.js"></script>
<script src="js/program_library.js" charset="utf-8"></script>
<script type="text/javascript">
	/* Define functions */
	var fastAES = function(entry, password, method=1) {
		/**
		 * @desc Uses CryptoJS AES function (defined at js/aes.js) to encrypt/decrypt a string
		 * @param {string} entry plain text OR encrypted plain text
		 * @param {string} password encryption/decryption password.
		 * @param {number} [method] encryption (1) OR decryption (2)
		 * @return {string} encrypted or decrypted value
		 */
		if (!(entry) || !(password)) {
			return;
		}
		if (method) {
			return CryptoJS.AES.encrypt(entry, password, "{ mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }") + "";
		} else if (!(method)) {
			return CryptoJS.AES.decrypt(entry, password, "{ mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }").toString(CryptoJS.enc.Utf8);
		} else {
			return;
		}
	};
	
	var fastHash = function(str, seed = 0) { // returns the hash of the hashes of the halves of the string
		return cyrb53(cyrb53(str.substring(0, str.length / 2), seed) + cyrb53(str.substring(str.length / 2), seed));
	};
	
	var cyrb53 = function(str, seed = 0) { // https://stackoverflow.com/a/52171480
		var h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
		for (var i = 0, ch; i < str.length; i++) {
			ch = str.charCodeAt(i);
			h1 = Math.imul(h1 ^ ch, 2654435761);
			h2 = Math.imul(h2 ^ ch, 1597334677);
		}
		h1 = Math.imul(h1 ^ (h1>>>16), 2246822507) ^ Math.imul(h2 ^ (h2>>>13), 3266489909);
		h2 = Math.imul(h2 ^ (h2>>>16), 2246822507) ^ Math.imul(h1 ^ (h1>>>13), 3266489909);
		return (h2>>>0).toString(16).padStart(8,0)+(h1>>>0).toString(16).padStart(8,0);
	};
	
	var sleep = function(milliseconds) {
		var date = Date.now();
		var currentDate = null;
		while (currentDate - date < milliseconds) {
			currentDate = Date.now();
		}
	};
	
	var validURL = function(url) {
		console.groupCollapsed("URL Test");
		console.count("Test #")
		console.log("Testing: '" + url + "'");
		try {
			var testURL = new URL(url);
		} catch (e) {
			console.log("FAIL");
			console.error(e.name,"\n",e.message);
			console.groupEnd("URL Test");
			return 0;
		}
		console.log("PASS");
		console.groupEnd("URL Test");
		return 1;
	};
	
	var formURL = function(url,days) {
		if (validURL(url)) {
			document.getElementById('response').innerHTML += "<br>Valid";
		} else {
			document.getElementById('response').innerHTML += "<br>Invalid";
			return
		}
		
		if (!(days)) {
			days = 60;
		} else if (days > 100) {
			days = 100;
		}
		
		var hpswd = fastHash(url + "");
		var hash = fastHash(hpswd);
		
		for (var i = 0; i < databaseKeys.length; i++) {
			if (hash == databaseKeys[i][0]) {
				document.getElementById('response').innerHTML += "<br>Hash already entered.";
				document.getElementById('URL-output').value = location.origin + location.pathname + "?q=" + hpswd + "&e";
				return
			}
		}
		
		databaseKeys.push([hash,url]);
		
		var submitFormURL = "https://docs.google.com/forms/d/e/"+ "1FAIpQLScD207jnL00K8krRRbyU6-Lm5nw1_QQ6AsGzLccXfpeorLAVw" + "/formResponse?usp=pp_url&entry.147838225=" + encodeURIComponent(fastAES(url,hpswd)) + "&entry.1116408077=" + hash + "&entry.747563745=" + days + "&submit=Submit";
		
		document.getElementById('submit-iframe').setAttribute("src",submitFormURL);
		document.getElementById('URL-output').value = location.origin + location.pathname + "?q=" + hpswd + "&e";
		document.getElementById('response').innerHTML += "<br>Quicklink created. This link will be deleted after approximately " + days + " day(s).";
	};
</script>
<script type="text/javascript">
	/* Processes the URL query and creates the redirect */
	var thisURL = new URL(window.location), hashRequest = "", eQuery = 0;
	if (thisURL.searchParams.has("q")) {
		var hashRequest = thisURL.searchParams.get("q");
		if (thisURL.searchParams.has("e")) {
			eQuery = 1;
		}
	}
	
	var databaseKeys = [];
	function processEntries(input) {
		console.time("time to process entries");
		var entries = input.feed.entry; // get the GS feed

		for (var i = 0; i < entries.length; i+=2) {
			var entry_key = entries[i]; // key
			var entry_URL = entries[i+1]; // URL

			databaseKeys.push([entry_key.content.$t,entry_URL.content.$t]);

			if (hashRequest) {
				var comparisonHash = (eQuery) ? fastHash(hashRequest) : hashRequest;
				if (entry_key.content.$t == comparisonHash) {
					var requestedURL = (eQuery) ? fastAES(entry_URL.content.$t,hashRequest,0) : entry_URL.content.$t;
					window.location = requestedURL;
					sleep(2000);
				}
			}
		}
		console.timeEnd("time to process entries");
	}
</script>
<script src="https://spreadsheets.google.com/feeds/cells/1XJBOYua9V6WKiwLfE-0Yif0se7XW0nDKwXvxD1lQfD4/od6/public/values?alt=json-in-script&callback=processEntries"></script>
<style>
	html, body {
		text-align: center;
		background-color: rgb(71, 57, 116);
		color: white;
		font-size: 150%;
		margin: 0px;
		height: 100%;
		width: 100%;
	}
	input {
		font-size: 50%;
	}
	input[type="text"] {
		width: 40%;
	}
	input[type="button"] {
		height: 10%;
	}
	label {
		font-size: 80%;
	}
	h1 > a {
		font-size: 25%;
	}
</style>
<body>
	<!-- Front page -->
	<div class="centering full" style="background: rgb(28, 24, 42);">
		<h1 class="front-header">Redirecting...</h1>
	</div>
	
	<noscript>
		<div id="blankspace"></div>
		
		For this site to perform its basic functions, it is necessary to enable JavaScript.<br>
		You can allow JavaScript in your browser settings <a href="https://www.whatismybrowser.com/guides/how-to-enable-javascript/auto">by following these instructions</a>.
		
		<div id="blankspace"></div>
	</noscript>
	
	<main>
		<p>This site uses a simple Google Sheets query to provide a quick redirection link. Enter a complete URL below to try it.<br>Links are encrypted to ensure data security and are deleted from the system automatically.</p>
	</main>
	
	<div id="blankspace"></div>
	
	<div id="quick-link">
		<h1>Create Quicklink<a href="redirects/#quick-link">#</a></h1>
		<!-- URL Entry -->
		<label for="URL-input">Input URL: </label>
		<input type="text" value="" id="URL-input">
		<input type="button" onclick="document.getElementById('URL-input').value = ''" value="X">
		<br>
		<!-- Expiration Days Entry -->
		<label for="numDays">Expiration days: </label>
		<input type="number" id="numDays" min="0" max="100" value="0">
		<input type="button" onclick="document.getElementById('numDays').value = 0" value="X">
		<br>
		<!-- Submission button -->
		<input type="button" onclick="formURL(document.getElementById('URL-input').value,document.getElementById('numDays').value)" value="Submit">
		<br>
		<!-- Output -->
		<label for="URL-output">Quick URL: </label>
		<input type="text" value="" id="URL-output">
		<input type="button" onclick="document.getElementById('URL-output').value = ''" value="X">
		<br>
		<!-- Copy URL button -->
		<input type="button" onclick="copyText('queryURL',document.getElementById('URL-output').value); document.getElementById('response').innerHTML += '<br>Copied';" value="Copy">
		<!-- Clear all button -->
		<input type="button" onclick="document.getElementById('response').innerHTML = 'Enter a valid URL, including the full protocol and domain.'; document.getElementById('URL-output').value = ''; document.getElementById('numDays').value = 0; document.getElementById('URL-input').value = '';" value="Clear">
		<br>
		<p id="response">Enter a valid URL, including the full protocol and domain.</p>
		<br>
		
		<!-- Submission iFrame -->
		<iframe src="" width="0" height="0" id="submit-iframe" style="border:none; padding:0%; margin:0%;"></iframe>
		<!-- Copy Box -->
		<input style="display:none;" type="text" value="URL" id="queryURL">
	</div>
	
	<div id="blankspace"></div>
	
	<div id="quick-hash">
		<h1>Quick Hasher<a href="redirects/#quick-hash">#</a></h1>
		<!-- Text entry -->
		<label for="quick-hash-input">Enter text to hash: </label>
		<input type="text" value="" id="quick-hash-input">
		<input type="button" onclick="document.getElementById('quick-hash-input').value = ''" value="X">
		<br>
		<!-- Submission button -->
		<input type="button" onclick="document.getElementById('quick-hash-output').value = fastHash(document.getElementById('quick-hash-input').value)" value="Hash">
		<br>
		<!-- Output -->
		<label for="quick-hash-output">Hash of text: </label>
		<input type="text" value="" id="quick-hash-output">
		<input type="button" onclick="document.getElementById('quick-hash-output').value = ''" value="X">
	</div>
	
	<div id="blankspace"></div>
	
	<div id="quick-aes">
		<h1>Quick AES Encryption<a href="redirects/#quick-aes">#</a></h1>
		<!-- Text input and password input -->
		<label for="quick-aes-input">Enter text to encrypt/decrypt: </label>
		<input type="text" value="" id="quick-aes-input">
		<input type="button" onclick="document.getElementById('quick-aes-input').value = ''" value="X">
		<br>
		<label for="quick-aes-password">Enter password: </label>
		<input type="text" value="password" id="quick-aes-password" style="width:20%;">
		<input type="button" onclick="document.getElementById('quick-aes-password').value = ''" value="X">
		<label for="quick-aes-password">Remember this password!</label>
		<br>
		
		<!-- Encryption button -->
		<input type="button" onclick="document.getElementById('quick-aes-output').value = fastAES(document.getElementById('quick-aes-input').value,document.getElementById('quick-aes-password').value,1)" value="Encrypt">
		
		<!-- Decryption button -->
		<input type="button" onclick="document.getElementById('quick-aes-output').value = fastAES(document.getElementById('quick-aes-input').value,document.getElementById('quick-aes-password').value,0)" value="Decrypt">
		<br>
		
		<!-- Output -->
		<label for="quick-aes-output">Encrypted/Decrypted text: </label>
		<input type="text" value="" id="quick-aes-output">
		<input type="button" onclick="document.getElementById('quick-aes-output').value = ''" value="X">
		<br>
		
		<!-- Sends output to input box -->
		<input type="button" onclick="document.getElementById('quick-aes-input').value = document.getElementById('quick-aes-output').value" value="Output to Input">
		<br>
	</div>
	
	<div id="blankspace"></div>
	
</body>
</html>
